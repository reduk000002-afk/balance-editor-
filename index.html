<!DOCTYPE html>
<html>
<head>
    <title>Admin Panel | Управление сделками</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-dark: #0a0e17;
            --secondary-dark: #13182b;
            --accent-blue: #1a5dff;
            --accent-cyan: #00d4ff;
            --text-primary: #ffffff;
            --text-secondary: #8b9dc3;
            --success: #00ff88;
            --warning: #ffaa00;
            --danger: #ff4757;
            --border-color: #2a3a5c;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary-dark) 0%, #0c1120 100%);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
        }
        
        /* Уведомление о непрочитанных сообщениях */
        .unread-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(90deg, var(--warning), #ffaa0088);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 5px 15px rgba(255, 170, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: slideIn 0.5s ease;
            max-width: 400px;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .unread-notification.hidden {
            display: none;
        }
        
        .close-notification {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            margin-left: 10px;
        }
        
        /* Логин форма */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        
        .login-box {
            background: var(--secondary-dark);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 450px;
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            text-align: center;
        }
        
        .login-logo {
            font-size: 2.5rem;
            color: var(--accent-cyan);
            margin-bottom: 10px;
        }
        
        .login-title {
            font-size: 1.8rem;
            margin-bottom: 30px;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .input-group input {
            width: 100%;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 2px rgba(26, 93, 255, 0.2);
        }
        
        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-cyan));
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            margin-top: 10px;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(26, 93, 255, 0.4);
        }
        
        /* Основной контейнер */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            display: none;
        }
        
        /* Хедер */
        .admin-header {
            background: var(--secondary-dark);
            border-radius: 15px;
            padding: 20px 30px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--border-color);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .header-left h1 {
            font-size: 1.8rem;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .header-left p {
            color: var(--text-secondary);
            margin-top: 5px;
            font-size: 0.9rem;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-info {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px 15px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            font-size: 0.9rem;
        }
        
        .logout-btn {
            background: rgba(255, 71, 87, 0.1);
            color: var(--danger);
            border: 1px solid var(--danger);
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        
        .logout-btn:hover {
            background: var(--danger);
            color: white;
        }
        
        /* Вкладки */
        .tabs {
            display: flex;
            background: var(--secondary-dark);
            border-radius: 15px;
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            flex-wrap: wrap;
        }
        
        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            min-width: 150px;
            font-size: 0.9rem;
        }
        
        .tab:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .tab.active {
            background: rgba(26, 93, 255, 0.1);
            border-bottom: 3px solid var(--accent-blue);
            color: var(--accent-cyan);
        }
        
        .tab-badge {
            background: var(--warning);
            color: var(--primary-dark);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            margin-left: 5px;
            font-weight: bold;
        }
        
        /* Контент вкладок */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Статистика сделок */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: var(--secondary-dark);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
        }
        
        .stat-icon.trades {
            background: rgba(26, 93, 255, 0.1);
            color: var(--accent-blue);
        }
        
        .stat-icon.open {
            background: rgba(255, 170, 0, 0.1);
            color: var(--warning);
        }
        
        .stat-icon.closed {
            background: rgba(0, 255, 136, 0.1);
            color: var(--success);
        }
        
        .stat-icon.profit {
            background: rgba(0, 212, 255, 0.1);
            color: var(--accent-cyan);
        }
        
        .stat-info h3 {
            font-size: 2rem;
            margin-bottom: 5px;
        }
        
        .stat-info p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        /* Фильтры для сделок */
        .filters-container {
            background: var(--secondary-dark);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 200px;
            flex: 1;
        }
        
        .filter-group label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .filter-group select,
        .filter-group input {
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        
        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }
        
        .filter-btn {
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-cyan));
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.3s;
            align-self: flex-end;
        }
        
        .filter-btn:hover {
            transform: translateY(-2px);
        }
        
        /* Таблица сделок */
        .table-container {
            background: var(--secondary-dark);
            border-radius: 15px;
            padding: 0;
            overflow: hidden;
            border: 1px solid var(--border-color);
            margin-bottom: 30px;
            max-height: 600px;
            overflow-y: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }
        
        thead {
            background: rgba(0, 0, 0, 0.2);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        th {
            padding: 18px 15px;
            text-align: left;
            color: var(--text-secondary);
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }
        
        td {
            padding: 18px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            vertical-align: middle;
        }
        
        tr:last-child td {
            border-bottom: none;
        }
        
        tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }
        
        /* Стили для статусов */
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-processing {
            background: rgba(255, 170, 0, 0.2);
            color: var(--warning);
            border: 1px solid rgba(255, 170, 0, 0.3);
        }
        
        .status-closed {
            background: rgba(0, 255, 136, 0.2);
            color: var(--success);
            border: 1px solid rgba(0, 255, 136, 0.3);
        }
        
        .status-cancelled {
            background: rgba(255, 71, 87, 0.2);
            color: var(--danger);
            border: 1px solid rgba(255, 71, 87, 0.3);
        }
        
        /* Стили для PnL */
        .pnl-positive {
            color: var(--success);
            font-weight: bold;
        }
        
        .pnl-negative {
            color: var(--danger);
            font-weight: bold;
        }
        
        .pnl-neutral {
            color: var(--text-secondary);
        }
        
        /* Кнопки действий */
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            padding: 8px 12px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.85rem;
        }
        
        .edit-btn {
            background: rgba(0, 212, 255, 0.1);
            color: var(--accent-cyan);
            border: 1px solid var(--accent-cyan);
        }
        
        .edit-btn:hover {
            background: var(--accent-cyan);
            color: var(--primary-dark);
        }
        
        .delete-btn {
            background: rgba(255, 71, 87, 0.1);
            color: var(--danger);
            border: 1px solid var(--danger);
        }
        
        .delete-btn:hover {
            background: var(--danger);
            color: white;
        }
        
        /* Модальное окно редактирования сделки */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .modal-content {
            background: var(--secondary-dark);
            border-radius: 20px;
            padding: 30px;
            width: 100%;
            max-width: 500px;
            border: 1px solid var(--border-color);
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .close-modal {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
        }
        
        /* Форма редактирования */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .form-group select,
        .form-group input {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        
        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }
        
        .save-btn {
            flex: 1;
            padding: 12px;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-cyan));
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .save-btn:hover {
            opacity: 0.9;
        }
        
        .cancel-btn {
            flex: 1;
            padding: 12px;
            background: rgba(255, 71, 87, 0.1);
            color: var(--danger);
            border: 1px solid var(--danger);
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .cancel-btn:hover {
            background: var(--danger);
            color: white;
        }
        
        /* Toast уведомления */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--secondary-dark);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 1001;
            max-width: 400px;
        }
        
        /* Загрузка */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
            color: var(--text-secondary);
            font-size: 1rem;
        }
        
        .loading i {
            margin-right: 10px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ================== СТИЛИ ДЛЯ УПРАВЛЕНИЯ ПОЛЬЗОВАТЕЛЯМИ ================== */
        
        /* Статус */
        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-weight: 500;
            display: none;
            align-items: center;
            gap: 10px;
        }
        
        .status.success {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
        }
        
        .status.error {
            background: rgba(255, 71, 87, 0.1);
            border: 1px solid var(--danger);
            color: var(--danger);
        }
        
        /* Панель управления */
        .control-panel {
            background: var(--secondary-dark);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
        }
        
        .panel-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .panel-title h2 {
            font-size: 1.4rem;
        }
        
        .add-btn {
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-cyan));
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: transform 0.3s;
        }
        
        .add-btn:hover {
            transform: translateY(-2px);
        }
        
        /* Модальное окно подтверждения изменения баланса */
        .confirm-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .confirm-modal-content {
            background: var(--secondary-dark);
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            border: 1px solid var(--border-color);
        }
        
        .confirm-modal-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            color: var(--warning);
        }
        
        .confirm-modal-body {
            margin-bottom: 25px;
            line-height: 1.5;
        }
        
        .confirm-modal-actions {
            display: flex;
            gap: 15px;
        }
        
        .confirm-btn {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            border: none;
        }
        
        .confirm-yes {
            background: rgba(0, 255, 136, 0.1);
            color: var(--success);
            border: 1px solid var(--success);
        }
        
        .confirm-yes:hover {
            background: var(--success);
            color: var(--primary-dark);
        }
        
        .confirm-no {
            background: rgba(255, 71, 87, 0.1);
            color: var(--danger);
            border: 1px solid var(--danger);
        }
        
        .confirm-no:hover {
            background: var(--danger);
            color: white;
        }
        
        /* Элементы формы в таблице */
        .table-input, .table-select {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            color: var(--text-primary);
            width: 100%;
            font-size: 0.95rem;
        }
        
        .table-input:focus, .table-select:focus {
            outline: none;
            border-color: var(--accent-blue);
        }
        
        .user-login {
            font-weight: 600;
            color: var(--accent-cyan);
        }
        
        .user-email {
            color: var(--text-secondary);
        }
        
        .balance-cell {
            font-weight: 600;
            color: var(--success);
        }
        
        /* ================== СТИЛИ ДЛЯ ЧАТА ПОДДЕРЖКИ ================== */
        
        .chat-container {
            display: flex;
            gap: 20px;
            height: 700px;
        }
        
        .users-sidebar {
            width: 350px;
            background: var(--secondary-dark);
            border-radius: 15px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .users-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            background: rgba(0, 0, 0, 0.1);
        }
        
        .chat-search {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .chat-search input {
            width: 100%;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        
        .users-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .user-item {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.3s;
            position: relative;
            border-radius: 10px;
            margin-bottom: 5px;
        }
        
        .user-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .user-item.active {
            background: rgba(26, 93, 255, 0.1);
            border-left: 3px solid var(--accent-blue);
        }
        
        .user-email {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 5px;
            font-size: 0.95rem;
        }
        
        .user-id {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-family: monospace;
        }
        
        .last-message {
            font-size: 0.85rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }
        
        .unread-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: var(--accent-blue);
            color: white;
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 10px;
            min-width: 20px;
            text-align: center;
        }
        
        .chat-area {
            flex: 1;
            background: var(--secondary-dark);
            border-radius: 15px;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }
        
        .chat-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            background: rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .user-info-chat {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-info-chat i {
            color: var(--accent-blue);
        }
        
        .messages-area {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: rgba(0, 0, 0, 0.1);
        }
        
        .message {
            max-width: 70%;
            padding: 15px;
            border-radius: 15px;
            line-height: 1.4;
            position: relative;
            border: 1px solid transparent;
            animation: messageAppear 0.3s ease;
        }
        
        @keyframes messageAppear {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.user {
            background: rgba(26, 93, 255, 0.2);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
            border-color: rgba(26, 93, 255, 0.3);
        }
        
        .message.admin {
            background: rgba(0, 212, 255, 0.2);
            align-self: flex-end;
            border-bottom-right-radius: 5px;
            border-color: rgba(0, 212, 255, 0.3);
        }
        
        .message-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 8px;
            text-align: right;
        }
        
        .message.user .message-time {
            text-align: left;
        }
        
        .message.unread {
            border-left: 3px solid var(--warning);
        }
        
        .input-area {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            background: rgba(0, 0, 0, 0.1);
        }
        
        .input-area textarea {
            width: 100%;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 1rem;
            resize: none;
            min-height: 60px;
            font-family: 'Segoe UI', sans-serif;
        }
        
        .input-area textarea:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 2px rgba(26, 93, 255, 0.2);
        }
        
        .send-btn-chat {
            width: 100%;
            padding: 15px;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-cyan));
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-weight: 600;
            transition: opacity 0.3s;
        }
        
        .send-btn-chat:hover {
            opacity: 0.9;
        }
        
        .send-btn-chat:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .empty-state {
            text-align: center;
            padding: 50px;
            color: var(--text-secondary);
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        /* Адаптивность */
        @media (max-width: 1200px) {
            .container {
                padding: 10px;
            }
            
            table {
                display: block;
                overflow-x: auto;
            }
            
            .chat-container {
                flex-direction: column;
                height: auto;
                min-height: 700px;
            }
            
            .users-sidebar {
                width: 100%;
                height: 250px;
            }
        }
        
        @media (max-width: 768px) {
            .admin-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .header-right {
                width: 100%;
                justify-content: space-between;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .message {
                max-width: 85%;
            }
        }
    </style>
</head>
<body>
    <!-- Уведомление о непрочитанных сообщениях -->
    <div class="unread-notification hidden" id="unreadNotification">
        <i class="fas fa-exclamation-circle"></i>
        <div>
            <strong id="unreadNotificationText">У вас есть непрочитанные сообщения</strong> в разделе поддержка.
        </div>
        <button class="close-notification" onclick="hideUnreadNotification()">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <!-- Логин форма -->
    <div class="login-container" id="loginContainer">
        <div class="login-box">
            <div class="login-logo">
                <i class="fas fa-chart-line"></i>
            </div>
            <h1 class="login-title">Admin Panel | Сделки</h1>
            <div class="input-group">
                <label for="username"><i class="fas fa-user"></i> Логин</label>
                <input type="text" id="username" placeholder="Введите логин" value="admin9">
            </div>
            <div class="input-group">
                <label for="password"><i class="fas fa-lock"></i> Пароль</label>
                <input type="password" id="password" placeholder="Введите пароль" value="Admin.123451535">
            </div>
            <button class="login-btn" onclick="login()">
                <i class="fas fa-sign-in-alt"></i> Войти в панель
            </button>
        </div>
    </div>
    
    <!-- Toast уведомления -->
    <div class="toast" id="toast"></div>
    
    <!-- Основной интерфейс -->
    <div class="container" id="adminContainer">
        <!-- Хедер -->
        <div class="admin-header">
            <div class="header-left">
                <h1><i class="fas fa-chart-network"></i> Управление сделками</h1>
                <p>Мониторинг и управление торговыми позициями пользователей</p>
            </div>
            <div class="header-right">
                <div class="user-info">
                    <i class="fas fa-user-shield"></i> Администратор
                </div>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Выйти
                </button>
            </div>
        </div>
        
        <!-- Вкладки -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('trades')">
                <i class="fas fa-exchange-alt"></i> Сделки
                <span id="tradesBadge" class="tab-badge" style="display: none;">0</span>
            </div>
            <div class="tab" onclick="switchTab('users')">
                <i class="fas fa-users"></i> Пользователи
            </div>
            <div class="tab" onclick="switchTab('support')">
                <i class="fas fa-headset"></i> Поддержка
                <span id="supportBadge" class="tab-badge" style="display: none;">0</span>
            </div>
        </div>
        
        <!-- Вкладка Сделки -->
        <div id="tradesTab" class="tab-content active">
            <!-- Статистика -->
            <div class="stats-container" id="tradesStatsContainer">
                <div class="stat-card">
                    <div class="stat-icon trades">
                        <i class="fas fa-exchange-alt"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalTrades">0</h3>
                        <p>Всего сделок</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon open">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="openTrades">0</h3>
                        <p>На отработке</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon closed">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="closedTrades">0</h3>
                        <p>Закрытых</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon profit">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalProfit">0</h3>
                        <p>Общий PnL</p>
                    </div>
                </div>
            </div>
            
            <!-- Фильтры -->
            <div class="filters-container">
                <div class="filter-group">
                    <label>Статус</label>
                    <select id="filterStatus" onchange="applyFilters()">
                        <option value="all">Все статусы</option>
                        <option value="отработка">На отработке</option>
                        <option value="закрыта">Закрытые</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Направление</label>
                    <select id="filterDirection" onchange="applyFilters()">
                        <option value="all">Все направления</option>
                        <option value="Лонг">Лонг</option>
                        <option value="Шорт">Шорт</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Пользователь</label>
                    <input type="text" id="filterUser" placeholder="Поиск по ID или email" oninput="applyFilters()">
                </div>
                <div class="filter-group">
                    <label>Символ</label>
                    <select id="filterSymbol" onchange="applyFilters()">
                        <option value="all">Все символы</option>
                        <option value="BTC">BTC</option>
                        <option value="ETH">ETH</option>
                        <option value="AAPL">AAPL</option>
                        <option value="TSLA">TSLA</option>
                        <option value="NVDA">NVDA</option>
                    </select>
                </div>
                <button class="filter-btn" onclick="resetFilters()">
                    <i class="fas fa-redo"></i> Сбросить
                </button>
            </div>
            
            <!-- Таблица сделок -->
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Пользователь</th>
                            <th>Символ</th>
                            <th>Направление</th>
                            <th>Размер</th>
                            <th>Плечо</th>
                            <th>Цена входа</th>
                            <th>Статус</th>
                            <th>PnL</th>
                            <th>Дата открытия</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody id="tradesTable">
                        <tr>
                            <td colspan="11" class="loading">
                                <i class="fas fa-spinner"></i> Загрузка данных...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Вкладка Пользователи -->
        <div id="usersTab" class="tab-content">
            <!-- Статистика - только общее количество пользователей -->
            <div class="stats-container" id="usersStatsContainer">
                <div class="stat-card">
                    <div class="stat-icon users">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalUsers">0</h3>
                        <p>Всего пользователей</p>
                    </div>
                </div>
            </div>

            <!-- Панель управления -->
            <div class="control-panel">
                <div class="panel-title">
                    <h2><i class="fas fa-user-cog"></i> Управление пользователями</h2>
                    <button class="add-btn" onclick="showAddUserModal()">
                        <i class="fas fa-plus"></i> Добавить пользователя
                    </button>
                </div>
            </div>

            <!-- Таблица -->
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Логин</th>
                            <th>Email</th>
                            <th>Баланс (USD)</th>
                            <th>Уровень</th>
                            <th>Тип вывода</th>
                            <th>Дата регистрации</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody id="usersTable">
                        <tr>
                            <td colspan="7" class="loading">
                                <i class="fas fa-spinner"></i> Загрузка пользователей...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Вкладка Поддержка -->
        <div id="supportTab" class="tab-content">
            <div class="chat-container">
                <!-- Сайдбар со списком пользователей -->
                <div class="users-sidebar">
                    <div class="users-header">
                        <h3>Пользователи с обращениями</h3>
                    </div>
                    <div class="chat-search">
                        <input type="text" id="chatSearch" placeholder="Поиск по email или ID..." 
                               oninput="filterChatUsers(this.value)">
                    </div>
                    <div class="users-list" id="supportUsersList">
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <p>Нет активных обращений</p>
                        </div>
                    </div>
                </div>
                
                <!-- Основная область чата -->
                <div class="chat-area">
                    <div class="chat-header" id="chatHeader">
                        <div class="user-info-chat">
                            <i class="fas fa-user"></i>
                            <span id="selectedUserName">Выберите пользователя</span>
                        </div>
                        <div id="selectedUserEmail" style="color: var(--text-secondary); font-size: 0.9rem;"></div>
                    </div>
                    
                    <div class="messages-area" id="messagesArea">
                        <div class="empty-state">
                            <i class="fas fa-comments"></i>
                            <p>Выберите пользователя для общения</p>
                        </div>
                    </div>
                    
                    <div class="input-area" id="inputArea" style="display: none;">
                        <textarea 
                            id="messageInput" 
                            placeholder="Введите ответ..." 
                            rows="3"
                        ></textarea>
                        <button class="send-btn-chat" id="sendBtn" onclick="sendMessage()">
                            <i class="fas fa-paper-plane"></i> Отправить ответ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно добавления пользователя -->
    <div class="modal-overlay" id="addUserModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-user-plus"></i> Добавить нового пользователя</h2>
                <button class="close-modal" onclick="closeAddUserModal()">&times;</button>
            </div>
            <div class="input-group">
                <label for="newUserKey">Логин (user_key)</label>
                <input type="text" id="newUserKey" placeholder="Введите уникальный логин">
            </div>
            <div class="input-group">
                <label for="newPassword">Пароль</label>
                <input type="text" id="newPassword" placeholder="Введите пароль" value="12345">
            </div>
            <div class="input-group">
                <label for="newEmail">Email</label>
                <input type="email" id="newEmail" placeholder="Введите email (необязательно)">
            </div>
            <div class="input-group">
                <label for="newBalance">Начальный баланс</label>
                    <input type="number" id="newBalance" placeholder="0.00" step="0.01" value="0">
            </div>
            <div style="display: flex; gap: 15px; margin-top: 25px;">
                <button class="save-btn" style="flex: 1;" onclick="addNewUser()">
                    <i class="fas fa-check"></i> Создать
                </button>
                <button class="cancel-btn" style="flex: 1;" onclick="closeAddUserModal()">
                    <i class="fas fa-times"></i> Отмена
                </button>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно подтверждения изменения баланса -->
    <div class="confirm-modal-overlay" id="confirmBalanceModal">
        <div class="confirm-modal-content">
            <div class="confirm-modal-header">
                <i class="fas fa-exclamation-triangle fa-2x"></i>
                <h2>Подтверждение изменения баланса</h2>
            </div>
            <div class="confirm-modal-body" id="confirmBalanceMessage">
                <!-- Текст будет вставлен здесь -->
            </div>
            <div class="confirm-modal-actions">
                <button class="confirm-btn confirm-yes" onclick="confirmBalanceChange(true)">
                    <i class="fas fa-check"></i> Да, изменить
                </button>
                <button class="confirm-btn confirm-no" onclick="confirmBalanceChange(false)">
                    <i class="fas fa-times"></i> Отмена
                </button>
            </div>
        </div>
    </div>

    <!-- Модальное окно редактирования сделки -->
    <div class="modal-overlay" id="editTradeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-edit"></i> Редактирование сделки</h2>
                <button class="close-modal" onclick="closeEditTradeModal()">&times;</button>
            </div>
            <form id="editTradeForm" onsubmit="updateTrade(event)">
                <input type="hidden" id="editTradeId">
                
                <div class="form-group">
                    <label>Статус сделки</label>
                    <select id="editTradeStatus" required>
                        <option value="отработка">Отработка</option>
                        <option value="закрыта">Закрыта</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Прибыль/Убыток (PnL в USDT)</label>
                    <input type="number" id="editTradePnl" step="0.01" placeholder="Введите PnL (может быть отрицательным)">
                    <small style="color: var(--text-secondary); font-size: 0.8rem;">
                        Положительное значение - прибыль, отрицательное - убыток
                    </small>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="save-btn">
                        <i class="fas fa-save"></i> Сохранить изменения
                    </button>
                    <button type="button" class="cancel-btn" onclick="closeEditTradeModal()">
                        <i class="fas fa-times"></i> Отмена
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // =============================================
        // КОНФИГУРАЦИЯ SUPABASE
        // =============================================
        const SUPABASE_URL = 'https://wkukgnkfbxgpvlraczeu.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_11WBFNEcbspv1yDyfxq7sQ_Nl51ew5i';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // Данные для входа администратора
        const ADMIN_LOGIN = 'admin9';
        const ADMIN_PASSWORD = 'Admin.123451535';
        
        // Глобальные переменные
        let currentTrades = [];
        let currentUsers = [];
        let tradesChannel = null;
        let supportChannel = null;
        let usersChannel = null;
        let activeTab = 'trades';
        
        // Переменные для модального окна подтверждения изменения баланса
        let pendingBalanceChange = {
            userId: null,
            userKey: null,
            oldBalance: null,
            newBalance: null,
            balanceInput: null
        };
        
        // Переменные для чата поддержки
        let selectedUserId = null;
        let selectedUserEmail = null;
        let chatSubscription = null;
        let isSendingMessage = false;
        let currentMessages = [];
        let hasUnreadMessages = false;
        let unreadMessagesCount = 0;
        
        // =============================================
        // АВТОРИЗАЦИЯ
        // =============================================
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (username === ADMIN_LOGIN && password === ADMIN_PASSWORD) {
                // Успешный вход
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('adminContainer').style.display = 'block';
                
                // Загружаем данные
                await loadTrades();
                await loadUsers();
                await loadSupportUsers();
                
                // Настраиваем real-time подписки
                setupRealtimeSubscriptions();
                
                showToast('Добро пожаловать в панель управления!');
            } else {
                showToast('Неверный логин или пароль');
            }
        }
        
        function logout() {
            if (confirm('Вы уверены, что хотите выйти?')) {
                // Отписываемся от real-time
                if (tradesChannel) supabase.removeChannel(tradesChannel);
                if (supportChannel) supabase.removeChannel(supportChannel);
                if (usersChannel) supabase.removeChannel(usersChannel);
                if (chatSubscription) supabase.removeChannel(chatSubscription);
                
                // Возвращаем к логину
                document.getElementById('adminContainer').style.display = 'none';
                document.getElementById('loginContainer').style.display = 'flex';
                
                showToast('Вы вышли из системы');
            }
        }
        
        // =============================================
        // УПРАВЛЕНИЕ ВКЛАДКАМИ
        // =============================================
        function switchTab(tabName) {
            // Скрываем все вкладки
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Показываем выбранную вкладку
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.closest('.tab').classList.add('active');
            activeTab = tabName;
            
            // Загружаем данные если нужно
            if (tabName === 'users') {
                loadUsers();
            } else if (tabName === 'support') {
                loadSupportUsers();
                setupChatRealtime();
            } else if (tabName === 'trades') {
                loadTrades();
            }
        }
        
        // =============================================
        // УПРАВЛЕНИЕ СДЕЛКАМИ
        // =============================================
        async function loadTrades() {
            try {
                // Загружаем все сделки
                const { data: trades, error } = await supabase
                    .from('admin_trades_view')
                    .select('*')
                    .order('opened_at', { ascending: false });
                
                if (error) throw error;
                
                currentTrades = trades;
                displayTrades(trades);
                updateTradesStats(trades);
                
            } catch (error) {
                console.error('Ошибка загрузки сделок:', error);
                showToast('Ошибка загрузки сделок');
            }
        }
        
        function displayTrades(trades) {
            const table = document.getElementById('tradesTable');
            
            if (!trades || trades.length === 0) {
                table.innerHTML = `
                    <tr>
                        <td colspan="11" style="text-align: center; padding: 40px; color: var(--text-secondary)">
                            <i class="fas fa-exchange-alt" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                            Сделки не найдены
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            
            trades.forEach(trade => {
                const statusClass = `status-${trade.status === 'отработка' ? 'processing' : 'closed'}`;
                const statusText = trade.status === 'отработка' ? 'Отработка' : 'Закрыта';
                
                const pnlClass = trade.pnl > 0 ? 'pnl-positive' : 
                               trade.pnl < 0 ? 'pnl-negative' : 'pnl-neutral';
                const pnlDisplay = trade.pnl ? 
                    `${trade.pnl > 0 ? '+' : ''}${trade.pnl.toFixed(2)} USDT` : 
                    '—';
                
                const directionClass = trade.direction === 'Лонг' ? 'pnl-positive' : 'pnl-negative';
                
                html += `
                    <tr>
                        <td style="font-family: monospace; font-size: 0.8rem;">
                            ${trade.id.substring(0, 8)}...
                        </td>
                        <td>
                            <div style="font-weight: 600;">${trade.user_id}</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">
                                ${trade.user_email_full || trade.user_email || '—'}
                            </div>
                        </td>
                        <td>
                            <div style="font-weight: 600;">${trade.symbol}</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">
                                ${trade.symbol_full}
                            </div>
                        </td>
                        <td>
                            <span class="${directionClass}">${trade.direction}</span>
                        </td>
                        <td style="font-weight: 600;">${parseFloat(trade.size).toFixed(2)} USDT</td>
                        <td>${trade.leverage}x</td>
                        <td>${parseFloat(trade.entry_price).toFixed(2)}</td>
                        <td>
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </td>
                        <td class="${pnlClass}">${pnlDisplay}</td>
                        <td style="font-size: 0.85rem; color: var(--text-secondary);">
                            ${formatDateTime(trade.opened_at)}
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn edit-btn" onclick="openEditTradeModal('${trade.id}')">
                                    <i class="fas fa-edit"></i> Изменить
                                </button>
                                <button class="action-btn delete-btn" onclick="deleteTrade('${trade.id}')">
                                    <i class="fas fa-trash"></i> Удалить
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            table.innerHTML = html;
        }
        
        function updateTradesStats(trades) {
            const totalTrades = trades.length;
            const openTrades = trades.filter(t => t.status === 'отработка').length;
            const closedTrades = trades.filter(t => t.status === 'закрыта').length;
            const totalProfit = trades.reduce((sum, trade) => sum + (trade.pnl || 0), 0);
            
            document.getElementById('totalTrades').textContent = totalTrades;
            document.getElementById('openTrades').textContent = openTrades;
            document.getElementById('closedTrades').textContent = closedTrades;
            document.getElementById('totalProfit').textContent = totalProfit.toFixed(2);
            
            // Обновляем бейдж на вкладке
            const tradesBadge = document.getElementById('tradesBadge');
            if (openTrades > 0) {
                tradesBadge.textContent = openTrades;
                tradesBadge.style.display = 'inline';
            } else {
                tradesBadge.style.display = 'none';
            }
        }
        
        // =============================================
        // ФИЛЬТРАЦИЯ СДЕЛОК
        // =============================================
        function applyFilters() {
            const status = document.getElementById('filterStatus').value;
            const direction = document.getElementById('filterDirection').value;
            const user = document.getElementById('filterUser').value.toLowerCase();
            const symbol = document.getElementById('filterSymbol').value;
            
            let filteredTrades = [...currentTrades];
            
            if (status !== 'all') {
                filteredTrades = filteredTrades.filter(t => t.status === status);
            }
            
            if (direction !== 'all') {
                filteredTrades = filteredTrades.filter(t => t.direction === direction);
            }
            
            if (user) {
                filteredTrades = filteredTrades.filter(t => 
                    t.user_id.toLowerCase().includes(user) || 
                    (t.user_email_full && t.user_email_full.toLowerCase().includes(user)) ||
                    (t.user_email && t.user_email.toLowerCase().includes(user))
                );
            }
            
            if (symbol !== 'all') {
                filteredTrades = filteredTrades.filter(t => t.symbol === symbol);
            }
            
            displayTrades(filteredTrades);
        }
        
        function resetFilters() {
            document.getElementById('filterStatus').value = 'all';
            document.getElementById('filterDirection').value = 'all';
            document.getElementById('filterUser').value = '';
            document.getElementById('filterSymbol').value = 'all';
            displayTrades(currentTrades);
        }
        
        // =============================================
        // РЕДАКТИРОВАНИЕ СДЕЛКИ
        // =============================================
        let currentEditTrade = null;
        
        async function openEditTradeModal(tradeId) {
            try {
                const { data: trade, error } = await supabase
                    .from('trades')
                    .select('*')
                    .eq('id', tradeId)
                    .single();
                
                if (error) throw error;
                
                currentEditTrade = trade;
                
                // Заполняем форму
                document.getElementById('editTradeId').value = trade.id;
                document.getElementById('editTradeStatus').value = trade.status;
                document.getElementById('editTradePnl').value = trade.pnl || '';
                
                // Показываем модальное окно
                document.getElementById('editTradeModal').style.display = 'flex';
                
            } catch (error) {
                console.error('Ошибка загрузки сделки:', error);
                showToast('Ошибка загрузки сделки');
            }
        }
        
        function closeEditTradeModal() {
            document.getElementById('editTradeModal').style.display = 'none';
            currentEditTrade = null;
        }
        
        async function updateTrade(event) {
            event.preventDefault();
            
            const tradeId = document.getElementById('editTradeId').value;
            const status = document.getElementById('editTradeStatus').value;
            const pnl = parseFloat(document.getElementById('editTradePnl').value) || null;
            
            try {
                const updateData = {
                    status: status,
                    updated_at: new Date().toISOString()
                };
                
                // Добавляем PnL только если он указан
                if (pnl !== null) {
                    updateData.pnl = pnl;
                }
                
                // Если статус меняется на "закрыта" и не указано время закрытия
                if (status === 'закрыта' && !currentEditTrade.closed_at) {
                    updateData.closed_at = new Date().toISOString();
                    updateData.closed_by = 'admin';
                }
                
                const { error } = await supabase
                    .from('trades')
                    .update(updateData)
                    .eq('id', tradeId);
                
                if (error) throw error;
                
                closeEditTradeModal();
                showToast('Сделка успешно обновлена!');
                
            } catch (error) {
                console.error('Ошибка обновления сделки:', error);
                showToast('Ошибка обновления сделки');
            }
        }
        
        async function deleteTrade(tradeId) {
            if (!confirm('Вы уверены, что хотите удалить эту сделку?')) return;
            
            try {
                const { error } = await supabase
                    .from('trades')
                    .delete()
                    .eq('id', tradeId);
                
                if (error) throw error;
                
                showToast('Сделка успешно удалена!');
                
            } catch (error) {
                console.error('Ошибка удаления сделки:', error);
                showToast('Ошибка удаления сделки');
            }
        }
        
        // =============================================
        // УПРАВЛЕНИЕ ПОЛЬЗОВАТЕЛЯМИ
        // =============================================
        async function loadUsers() {
            try {
                const { data: users, error } = await supabase
                    .from('app_users')
                    .select('*')
                    .order('created', { ascending: false });
                
                if (error) throw error;
                
                currentUsers = users;
                displayUsers(users);
                updateUsersStats(users);
            } catch (error) {
                console.error('Ошибка загрузки пользователей:', error);
            }
        }
        
        function displayUsers(users) {
            const table = document.getElementById('usersTable');
            
            if (!users || users.length === 0) {
                table.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: var(--text-secondary)">
                            <i class="fas fa-users-slash" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                            Пользователи не найдены
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            
            users.forEach(user => {
                const createdDate = user.created ? new Date(user.created).toLocaleDateString('ru-RU') : '-';
                const originalBalance = user.balance || 0;
                
                html += `
                    <tr>
                        <td>
                            <div class="user-login">${escapeHtml(user.user_key)}</div>
                        </td>
                        <td class="user-email">${escapeHtml(user.email || '-')}</td>
                        <td class="balance-cell">
                            <input type="number" 
                                   class="table-input" 
                                   id="bal_${user.id}" 
                                   value="${originalBalance}" 
                                   step="0.01"
                                   data-original="${originalBalance}"
                                   onchange="handleBalanceChange('${user.id}', '${escapeHtml(user.user_key)}', ${originalBalance}, this.value, this)">
                        </td>
                        <td>
                            <select class="table-select" id="lev_${user.id}">
                                <option ${user.level === 'Стандарт' ? 'selected' : ''}>Стандарт</option>
                                <option ${user.level === 'VIP 1' ? 'selected' : ''}>VIP 1</option>
                                <option ${user.level === 'VIP 2' ? 'selected' : ''}>VIP 2</option>
                                <option ${user.level === 'VIP 3' ? 'selected' : ''}>VIP 3</option>
                            </select>
                        </td>
                        <td>
                            <select class="table-select" id="wt_${user.id}">
                                <option value="normal" ${user.withdraw_type === 'normal' ? 'selected' : ''}>Normal</option>
                                <option value="request" ${user.withdraw_type === 'request' ? 'selected' : ''}>Request</option>
                                <option value="commission" ${user.withdraw_type === 'commission' ? 'selected' : ''}>Commission</option>
                            </select>
                        </td>
                        <td style="color: var(--text-secondary); font-size: 0.9rem;">
                            ${createdDate}
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn edit-btn" onclick="saveUser('${user.id}')">
                                    <i class="fas fa-save"></i> Сохранить
                                </button>
                                <button class="action-btn delete-btn" onclick="deleteUser('${user.id}', '${escapeHtml(user.user_key)}')">
                                    <i class="fas fa-trash"></i> Удалить
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            table.innerHTML = html;
        }
        
        function updateUsersStats(users) {
            const totalUsers = users.length;
            document.getElementById('totalUsers').textContent = totalUsers;
        }
        
        // Обработка изменения баланса
        function handleBalanceChange(userId, userKey, oldBalance, newBalance, inputElement) {
            const newBalanceNum = parseFloat(newBalance);
            const oldBalanceNum = parseFloat(oldBalance);
            
            if (newBalanceNum === oldBalanceNum) return;
            
            pendingBalanceChange = {
                userId: userId,
                userKey: userKey,
                oldBalance: oldBalanceNum,
                newBalance: newBalanceNum,
                balanceInput: inputElement
            };
            
            const message = `Вы хотите изменить баланс пользователя <strong>"${escapeHtml(userKey)}"</strong><br><br>
                           Старый баланс: <span style="color: var(--success)">$${oldBalanceNum.toFixed(2)}</span><br>
                           Новый баланс: <span style="color: var(--accent-cyan)">$${newBalanceNum.toFixed(2)}</span><br><br>
                           Разница: <span style="color: ${newBalanceNum > oldBalanceNum ? 'var(--success)' : 'var(--danger)'}">
                           ${newBalanceNum > oldBalanceNum ? '+' : ''}$${(newBalanceNum - oldBalanceNum).toFixed(2)}</span>`;
            
            document.getElementById('confirmBalanceMessage').innerHTML = message;
            document.getElementById('confirmBalanceModal').style.display = 'flex';
        }
        
        function confirmBalanceChange(confirm) {
            const modal = document.getElementById('confirmBalanceModal');
            modal.style.display = 'none';
            
            if (confirm) {
                saveUserBalance(pendingBalanceChange.userId);
            } else {
                if (pendingBalanceChange.balanceInput) {
                    pendingBalanceChange.balanceInput.value = pendingBalanceChange.oldBalance;
                }
            }
            
            pendingBalanceChange = {
                userId: null,
                userKey: null,
                oldBalance: null,
                newBalance: null,
                balanceInput: null
            };
        }
        
        async function saveUser(userId) {
            try {
                const level = document.getElementById(`lev_${userId}`).value;
                const withdrawType = document.getElementById(`wt_${userId}`).value;
                const balanceInput = document.getElementById(`bal_${userId}`);
                const balance = parseFloat(balanceInput.value) || 0;
                
                const { error } = await supabase
                    .from('app_users')
                    .update({ 
                        balance: balance,
                        level: level,
                        withdraw_type: withdrawType,
                        updated_at: new Date().toISOString(),
                        updated_by: 'admin'
                    })
                    .eq('id', userId);
                
                if (error) throw error;
                
                balanceInput.setAttribute('data-original', balance);
                showToast('✅ Данные пользователя сохранены!');
                loadUsers();
            } catch (error) {
                console.error('Ошибка сохранения:', error);
                showToast('❌ Ошибка сохранения');
            }
        }
        
        async function saveUserBalance(userId) {
            try {
                const balanceInput = document.getElementById(`bal_${userId}`);
                const balance = parseFloat(balanceInput.value) || 0;
                
                const { error } = await supabase
                    .from('app_users')
                    .update({ 
                        balance: balance,
                        updated_at: new Date().toISOString(),
                        updated_by: 'admin'
                    })
                    .eq('id', userId);
                
                if (error) throw error;
                
                balanceInput.setAttribute('data-original', balance);
                showToast('✅ Баланс пользователя обновлен!');
                
            } catch (error) {
                console.error('Ошибка сохранения баланса:', error);
                showToast('❌ Ошибка сохранения баланса');
            }
        }
        
        async function deleteUser(userId, userKey) {
            if (!confirm(`Вы уверены, что хотите удалить пользователя "${userKey}"?`)) return;
            
            try {
                const { error } = await supabase
                    .from('app_users')
                    .delete()
                    .eq('id', userId);
                
                if (error) throw error;
                
                showToast('✅ Пользователь успешно удален!');
                loadUsers();
                
            } catch (error) {
                console.error('Ошибка удаления:', error);
                showToast('❌ Ошибка удаления');
            }
        }
        
        function showAddUserModal() {
            document.getElementById('addUserModal').style.display = 'flex';
            document.getElementById('newUserKey').focus();
        }
        
        function closeAddUserModal() {
            document.getElementById('addUserModal').style.display = 'none';
            document.getElementById('newUserKey').value = '';
            document.getElementById('newEmail').value = '';
            document.getElementById('newBalance').value = '0';
        }
        
        async function addNewUser() {
            const userKey = document.getElementById('newUserKey').value.trim();
            const password = document.getElementById('newPassword').value;
            const email = document.getElementById('newEmail').value.trim();
            const balance = parseFloat(document.getElementById('newBalance').value) || 0;
            
            if (!userKey || !password) {
                showToast('Введите логин и пароль пользователя');
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('app_users')
                    .insert([{
                        user_key: userKey,
                        password: password,
                        email: email || null,
                        balance: balance,
                        level: 'Стандарт',
                        withdraw_type: 'normal',
                        updated_by: 'admin'
                    }]);
                
                if (error) throw error;
                
                showToast('✅ Пользователь успешно добавлен!');
                closeAddUserModal();
                loadUsers();
                
            } catch (error) {
                console.error('Ошибка добавления:', error);
                showToast('❌ Ошибка добавления');
            }
        }
        
        // =============================================
        // ПОДДЕРЖКА
        // =============================================
        async function loadSupportUsers() {
            try {
                const { data: messages, error: messagesError } = await supabase
                    .from('support_chat')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (messagesError) throw messagesError;
                
                const { data: users, error: usersError } = await supabase
                    .from('app_users')
                    .select('user_key, email')
                    .order('created', { ascending: false });
                
                if (usersError) throw usersError;
                
                const userEmailMap = new Map();
                users.forEach(user => {
                    userEmailMap.set(user.user_key, user.email || 'Не указан');
                });
                
                const usersMap = new Map();
                
                messages.forEach(msg => {
                    if (!usersMap.has(msg.user_id)) {
                        const userEmail = userEmailMap.get(msg.user_id) || (msg.user_email || 'Не указан');
                        usersMap.set(msg.user_id, {
                            user_id: msg.user_id,
                            user_email: userEmail,
                            last_message: '',
                            last_message_time: null,
                            unread_count: 0,
                            messages: []
                        });
                    }
                    
                    const user = usersMap.get(msg.user_id);
                    user.messages.push(msg);
                    
                    if (!user.last_message_time || new Date(msg.created_at) > new Date(user.last_message_time)) {
                        user.last_message = msg.message;
                        user.last_message_time = msg.created_at;
                    }
                    
                    if (!msg.read && !msg.is_admin) {
                        user.unread_count++;
                    }
                });
                
                const supportUsers = Array.from(usersMap.values());
                const usersWithMessages = supportUsers.filter(user => user.messages.length > 0);
                
                displaySupportUsers(usersWithMessages);
                
                let totalUnread = 0;
                usersWithMessages.forEach(user => {
                    totalUnread += user.unread_count;
                });
                
                unreadMessagesCount = totalUnread;
                
                const badge = document.getElementById('supportBadge');
                if (totalUnread > 0) {
                    badge.textContent = totalUnread;
                    badge.style.display = 'inline';
                } else {
                    badge.style.display = 'none';
                }
                
            } catch (error) {
                console.error('Ошибка загрузки поддержки:', error);
            }
        }
        
        function displaySupportUsers(users) {
            const usersList = document.getElementById('supportUsersList');
            
            if (users.length === 0) {
                usersList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-users"></i>
                        <p>Нет активных обращений</p>
                    </div>
                `;
                return;
            }
            
            users.sort((a, b) => new Date(b.last_message_time) - new Date(a.last_message_time));
            
            let html = '';
            users.forEach(user => {
                const lastMessageTime = user.last_message_time 
                    ? new Date(user.last_message_time).toLocaleTimeString('ru-RU', {
                        hour: '2-digit',
                        minute: '2-digit'
                    })
                    : '';
                
                html += `
                    <div class="user-item" onclick="selectSupportUser('${user.user_id}', '${escapeHtml(user.user_email)}')">
                        <div class="user-email">${escapeHtml(user.user_email)}</div>
                        <div class="user-id">ID: ${user.user_id.substring(0, 20)}...</div>
                        <div class="last-message" title="${escapeHtml(user.last_message)}">
                            ${escapeHtml(user.last_message.substring(0, 50))}${user.last_message.length > 50 ? '...' : ''}
                        </div>
                        ${lastMessageTime ? `<div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 5px;">${lastMessageTime}</div>` : ''}
                        ${user.unread_count > 0 ? `<div class="unread-badge">${user.unread_count}</div>` : ''}
                    </div>
                `;
            });
            
            usersList.innerHTML = html;
        }
        
        function filterChatUsers(searchTerm) {
            const userItems = document.querySelectorAll('#supportUsersList .user-item');
            searchTerm = searchTerm.toLowerCase();
            
            userItems.forEach(item => {
                const email = item.querySelector('.user-email').textContent.toLowerCase();
                const userId = item.querySelector('.user-id').textContent.toLowerCase();
                
                if (email.includes(searchTerm) || userId.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        async function selectSupportUser(userId, userEmail) {
            selectedUserId = userId;
            selectedUserEmail = userEmail;
            
            document.querySelectorAll('#supportUsersList .user-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.user-item').classList.add('active');
            
            document.getElementById('selectedUserName').textContent = userEmail || userId;
            document.getElementById('selectedUserEmail').textContent = `ID: ${userId}`;
            
            document.getElementById('inputArea').style.display = 'block';
            await loadSupportMessages();
            await markSupportMessagesAsRead();
            document.getElementById('messageInput').focus();
        }
        
        async function loadSupportMessages() {
            if (!selectedUserId) return;
            
            try {
                const { data: messages, error } = await supabase
                    .from('support_chat')
                    .select('*')
                    .eq('user_id', selectedUserId)
                    .order('created_at', { ascending: true });
                
                if (error) throw error;
                
                currentMessages = messages;
                displaySupportMessages(messages);
                
            } catch (error) {
                console.error('Ошибка загрузки сообщений:', error);
            }
        }
        
        function displaySupportMessages(messages) {
            const messagesArea = document.getElementById('messagesArea');
            messagesArea.innerHTML = '';
            
            if (messages.length === 0) {
                messagesArea.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-comment"></i>
                        <p>Нет сообщений</p>
                    </div>
                `;
                return;
            }
            
            messages.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
            
            messages.forEach(msg => {
                const messageDiv = createMessageElement(msg);
                messagesArea.appendChild(messageDiv);
            });
            
            scrollToBottom();
        }
        
        function createMessageElement(msg) {
            const messageDiv = document.createElement('div');
            const time = new Date(msg.created_at).toLocaleTimeString('ru-RU', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            messageDiv.className = `message ${msg.is_admin ? 'admin' : 'user'} ${!msg.read && !msg.is_admin ? 'unread' : ''}`;
            messageDiv.setAttribute('data-message-id', msg.id);
            messageDiv.innerHTML = `
                <div>${escapeHtml(msg.message)}</div>
                <div class="message-time">${time} ${msg.is_admin ? '(Вы)' : ''}</div>
            `;
            
            return messageDiv;
        }
        
        async function sendMessage() {
            if (isSendingMessage) return;
            
            if (!selectedUserId || !selectedUserEmail) {
                showToast('Выберите пользователя');
                return;
            }
            
            const message = document.getElementById('messageInput').value.trim();
            
            if (!message) {
                showToast('Введите сообщение');
                document.getElementById('messageInput').focus();
                return;
            }
            
            isSendingMessage = true;
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Отправка...';
            
            try {
                const messageData = {
                    user_id: selectedUserId,
                    message: message,
                    is_admin: true,
                    read: false,
                    created_at: new Date().toISOString()
                };
                
                const { error } = await supabase
                    .from('support_chat')
                    .insert([messageData]);
                
                if (error) throw error;
                
                document.getElementById('messageInput').value = '';
                document.getElementById('messageInput').focus();
                
            } catch (error) {
                console.error('Ошибка отправки сообщения:', error);
                showToast('❌ Ошибка отправки сообщения');
            } finally {
                isSendingMessage = false;
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Отправить ответ';
            }
        }
        
        document.getElementById('messageInput').addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        });
        
        async function markSupportMessagesAsRead() {
            if (!selectedUserId) return;
            
            try {
                const { error } = await supabase
                    .from('support_chat')
                    .update({ read: true })
                    .eq('user_id', selectedUserId)
                    .eq('is_admin', false)
                    .eq('read', false);
                
                if (error) throw error;
                
                await loadSupportUsers();
                
            } catch (error) {
                console.error('Ошибка обновления статуса сообщений:', error);
            }
        }
        
        function scrollToBottom() {
            setTimeout(() => {
                const messagesArea = document.getElementById('messagesArea');
                messagesArea.scrollTop = messagesArea.scrollHeight;
            }, 100);
        }
        
        // Скрыть уведомление о непрочитанных сообщениях
        function hideUnreadNotification() {
            document.getElementById('unreadNotification').classList.add('hidden');
        }
        
        // =============================================
        // REAL-TIME ПОДПИСКИ
        // =============================================
        function setupRealtimeSubscriptions() {
            // Подписка на сделки
            tradesChannel = supabase
                .channel('admin-trades-realtime')
                .on('postgres_changes', 
                    { 
                        event: '*', 
                        schema: 'public', 
                        table: 'trades' 
                    },
                    async (payload) => {
                        console.log('Real-time обновление сделки:', payload);
                        await loadTrades();
                    }
                )
                .subscribe();
            
            // Подписка на пользователей
            usersChannel = supabase
                .channel('admin-users-realtime')
                .on('postgres_changes',
                    {
                        event: '*',
                        schema: 'public',
                        table: 'app_users'
                    },
                    async (payload) => {
                        console.log('Real-time обновление пользователя:', payload);
                        await loadUsers();
                    }
                )
                .subscribe();
            
            setupChatRealtime();
        }
        
        function setupChatRealtime() {
            if (chatSubscription) {
                supabase.removeChannel(chatSubscription);
            }
            
            chatSubscription = supabase
                .channel('support_chat_admin')
                .on('postgres_changes', 
                    { 
                        event: 'INSERT', 
                        schema: 'public', 
                        table: 'support_chat' 
                    },
                    async (payload) => {
                        console.log('Новое сообщение получено:', payload.new);
                        
                        if (!payload.new.is_admin && !payload.new.read) {
                            unreadMessagesCount++;
                        }
                        
                        await loadSupportUsers();
                        
                        if (selectedUserId && payload.new.user_id === selectedUserId) {
                            const existingMessage = document.querySelector(`[data-message-id="${payload.new.id}"]`);
                            if (!existingMessage) {
                                const messageDiv = createMessageElement(payload.new);
                                document.getElementById('messagesArea').appendChild(messageDiv);
                                scrollToBottom();
                            }
                        }
                    }
                )
                .on('postgres_changes',
                    {
                        event: 'UPDATE',
                        schema: 'public',
                        table: 'support_chat'
                    },
                    async (payload) => {
                        console.log('Сообщение обновлено:', payload.new);
                        
                        if (payload.new.read && payload.old.read === false && !payload.new.is_admin) {
                            await loadSupportUsers();
                        }
                    }
                )
                .subscribe();
        }
        
        // =============================================
        // ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ
        // =============================================
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.display = 'block';
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }
        
        function formatDateTime(dateString) {
            if (!dateString) return '—';
            const date = new Date(dateString);
            return date.toLocaleDateString('ru-RU') + ' ' + 
                   date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // =============================================
        // ИНИЦИАЛИЗАЦИЯ
        // =============================================
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('username').focus();
            
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Enter' && document.getElementById('loginContainer').style.display !== 'none') {
                    login();
                }
            });
        });
    </script>
</body>
</html>
